---
title: "Checkpoint 3"
author: "Ruan Victor Bertoldo Reis de Amorim"
date: "9 de maio de 2017"
output: html_document
---

## 1. Introdução

* **Nível:** Conceito da CAPES para um determinado programa de pós-graduação.

* **periodicos_A1:** Número de periódicos de qualis A1 publicados pelo PPG.

* **periodicos_A2:** Número de periódicos de qualis A2 publicados pelo PPG.

* **per_comaluno_A1:** Número de alunos que são autores ou co-autores de periódicos de qualis A1.

* **per_comaluno_A2:** Número de alunos que são autores ou co-autores de periódicos de qualis A2.

```{r, message=FALSE, warning=FALSE}
require(GGally, quietly = TRUE)
require(reshape2, quietly = TRUE)
require(tidyverse, quietly = TRUE, warn.conflicts = FALSE)
library(ggfortify)
library(cluster)
library(ggdendro)
library(broom)
library(knitr)

dados_capes = read_csv("dados/capes-cacc.csv")

formata_label = function(l){
  # existem funções para formatar com , sendo milhar e . sendo decimal (scales::comma)
  # mas em pt_br é o contrário. essa função serve para isso
  format(l, big.mark = ".", scientific = FALSE, trim = TRUE, decimal.mark = ",")
}

```

## 2. Descrição das variáveis

### 2.1 Nível

### 2.2 periodicos_A1

### 2.3 periodicos_A2

### 2.4 per_comaluno_A1

### 2.5 per_comaluno_A2

## 3. Tratamento dos dados

```{r}
dados_capes = dados_capes %>% 
  select(Sigla, `Nível`, periodicos_A1, periodicos_A2, per_comaluno_A1, per_comaluno_A2)

dados_capes = dados_capes %>%
  filter(complete.cases(dados_capes))

dados_capes2 = dados_capes
```


```{r}
dados_capes %>% 
    gather(key = "variavel", value = "valor", -Sigla) %>% 
    ggplot(aes(x = valor)) + 
    geom_histogram(fill = "lightyellow", color = "black", bins = 20) + 
    facet_grid(. ~ variavel, scales = "free_x")
```



## 4. Critérios de Escolha para o Número de Grupos

### 4.1 Dendrograma

### 4.2 Dissimilaridade da Junção

## 5. Avaliação do Agrupamento

### 5.1 Silhoueta

## 6. Agrupamentos

### 6.1 Agrupamento com hclust

### 6.2 Agrupamento com Kmeans

```{r, message=FALSE, warning=FALSE}

n_clusters = 5

dados_capes.scaled = select(dados_capes, -Sigla) %>% 
  mutate_each(funs(scale))

row.names(dados_capes.scaled)  = dados_capes$Sigla

toclust = dados_capes.scaled %>% 
   rownames_to_column(var = "universidade") %>% 
   select(1:6) 

dists = toclust %>% 
    select(-universidade) %>% 
    dist()

km = toclust %>% 
    select(-universidade) %>% 
    kmeans(centers = n_clusters, nstart = 20)

km %>% 
  augment(toclust) %>% 
  gather(key = "variáveis", value = "z-score", -universidade,  -.cluster) %>% 
  ggplot(aes(x = `variáveis`, y = `z-score`, group = universidade, colour = .cluster)) + 
  geom_point(alpha = 0.2) + 
  geom_line(alpha = .5) + 
  facet_wrap(~ .cluster) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1))

autoplot(km, data = dados_capes.scaled, label = TRUE)
plot(silhouette(km$cluster, dists), col = RColorBrewer::brewer.pal(n_clusters, "Set2"))

dados_capes.scaled$kmcluster = km$cluster

table(km$cluster)

km %>% 
    augment(toclust) %>% 
    select(universidade, .cluster) %>% 
    filter(.cluster == 1)

```

## PCA

Análise de componentes principais (PCA) é uma técnica usada para enfatizar a variação e trazer padrões fortes em um conjunto de dados. É freqüentemente usado para tornar os dados fáceis de explorar e visualizar. Inicialmente, iremos executar o PCA em nossos dados com scale = TRUE para que sejam feitas as normalizações, evitando o impacto de discrepâncias dos valores nas variâncias. Em seguida, encontraremos e veremos os componentes e sua relação com as variáveis originais.

```{r, message=FALSE, warning=FALSE}
row.names(dados_capes) = dados_capes$Sigla

pr.out = prcomp(select(dados_capes, -Sigla), scale = TRUE) 

kable(pr.out$rotation)
```

Utilizamos a função plot_pve para analisarmos quanta variância cada PC captura, observamos que os dois primeiros componentes explicam cerca de 95% da variância.

```{r}
# Porcentagem da variância explicada: 
plot_pve <- function(prout){
  pr.var <- pr.out$sdev^2
  pve <- pr.var / sum(pr.var)
  df = data.frame(x = 1:NROW(pve), y = cumsum(pve))
  ggplot(df, aes(x = x, y = y)) + 
    geom_point(size = 3) + 
    geom_line() + 
    labs(x='Principal Component', y = 'Cumulative Proportion of Variance Explained')
}

plot_pve(pr.out)
```

O gráficos a seguir mostram a estrutura dos grupos formados pela execução do PCA. Podemos percerber que algumas universidades se encontram aglomeradas em algumas regiões, outras já se mantém muito isoladas como a USP/SC, UFRGS, UFPE e UFRJ.

```{r, message=FALSE, warning=FALSE}
autoplot(pr.out, label = TRUE, label.size = 3, shape = FALSE)
```

Quando aplicamos os vetores de direcionamento com suas respectivas variáveis, conseguimos entender os comportamentos existentes nos dados. Podemos observar que as universidades que mais publicam em periódicos com qualis A1 e A2, e que possuem maior número de alunos entre os autores, são tambem as universidades que possuem melhor conceito (nível) da CAPES no seu programa de pós-graduação. No entanto, esse não é o único critério para definição do conceito, por exemplo, a USP/SC possui 175 publicações em periódicos de qualis A1 e 84 de qualis A2, porém, seu conceito é 6, que é menor que o conceito da UFRJ (conceito 7) que posssui 48 periódicos de qualis A1 e 89 de qualis A2. As universidades que se mantiveram mais aglomeradas são as que possuem menor quantidade de periódicos A1 e A2, consequentemente, também são as que possuem menor conceito pela CAPES. Existe uma co-relação forte entre os números de publicações em periódicos e o número de alunos que tiveram seu nome entre os autores nesses periódicos, no entanto, tal comportamento já era obviamente esperado.

```{r, message=FALSE, warning=FALSE}
biplot(pr.out, scale = 0)

autoplot(pr.out, label = TRUE, label.size = 3, shape = FALSE, 
         loadings = TRUE, loadings.colour = 'blue',
         loadings.label = TRUE, loadings.label.size = 3)
```

## t-SNE

```{r, message=FALSE, warning=FALSE}
require(Rtsne)

tsne.out = Rtsne(dados_capes2, 
                 verbose = TRUE,
                 perplexity = 5)

df = as.data.frame(tsne.out$Y)
df$Sigla = dados_capes2$Sigla

ggplot(df, aes(x = V1, y = V2, label = Sigla)) + 
  geom_point(alpha = 0.8, size = 3, color = "tomato") 

ggplot(df, aes(x = V1, y = V2, label = Sigla)) + 
  geom_point(alpha = 0.2, size = 3, color = "tomato") + 
  geom_text(alpha = .7, size = 4, hjust = -.2)

```